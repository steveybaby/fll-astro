---
import { getCollection } from 'astro:content';
import Layout from '../components/Layout.astro';

// Get all meetings and sort them chronologically
const meetings = await getCollection('meetings');
const sortedMeetings = meetings.sort((a, b) => {
  const dateA = a.data.date instanceof Date ? a.data.date : new Date(`${a.data.date}T00:00:00Z`);
  const dateB = b.data.date instanceof Date ? b.data.date : new Date(`${b.data.date}T00:00:00Z`);
  return dateA.getTime() - dateB.getTime();
});

// Fixed list of children in specified order
const children = ['Jasper', 'Asher', 'Kai', 'Jeremiah', 'Luca', 'Ethan'];

// API endpoint
const RSVP_API_URL = 'https://script.google.com/macros/s/AKfycbwFpY_VgGndIStuh1UOu1wA--QXMDWjVLaiLAjqMDOO58x9dA2H4RkOJ8daCtyc8BNPfQ/exec';

// Helper function to format meeting date
const formatMeetingDisplay = (date) => {
  const raw = date instanceof Date ? date : new Date(`${date}T00:00:00Z`);
  return new Intl.DateTimeFormat('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    timeZone: 'UTC',
  }).format(raw);
};

const formatMeetingISO = (date) => {
  const raw = date instanceof Date ? date : new Date(`${date}T00:00:00Z`);
  return new Intl.DateTimeFormat('en-CA', { timeZone: 'UTC' }).format(raw);
};
---

<Layout title="RSVPs - Team Overview" description="Comprehensive RSVP management for all FLL team meetings">
  <div class="rsvp-page-container">
    <header class="rsvp-header">
      <h1>üìã Team RSVPs</h1>
      <p>Manage attendance for all team meetings in one place</p>
      
      <div class="rsvp-updating-global" id="rsvp-updating-global" style="display: none;">
        <div class="updating-spinner-global"></div>
        <span>Saving...</span>
      </div>
    </header>

    <div class="rsvp-loading-global" id="rsvp-loading-global">
      <div class="loading-spinner-global"></div>
      <span>Loading RSVP data from Google Sheets...</span>
    </div>

    <div class="rsvp-error-global" id="rsvp-error-global" style="display: none;">
      <p id="rsvp-error-message-global">Unable to load RSVP data</p>
      <button id="rsvp-retry-global" class="retry-button">Try Again</button>
    </div>

    <div class="rsvp-grid-container" id="rsvp-grid-container" style="display: none;">
      <div class="rsvp-grid">
        <!-- Header row with children names -->
        <div class="grid-header">
          <div class="meeting-header-cell">Meeting</div>
          {children.map((child) => (
            <div class="child-header-cell">{child}</div>
          ))}
        </div>

        <!-- Meeting rows -->
        {sortedMeetings.map((meeting) => {
          const isoDate = formatMeetingISO(meeting.data.date);
          const displayDate = formatMeetingDisplay(meeting.data.date);
          
          return (
            <div class="grid-row" data-meeting-date={isoDate}>
              <div class="meeting-cell">
                <div class="meeting-info">
                  <a href={`/meetings/${meeting.slug}/`} class="meeting-link">
                    {meeting.data.title}
                  </a>
                  <div class="meeting-date">{displayDate}</div>
                </div>
              </div>
              {children.map((child) => (
                <div class="rsvp-cell" data-child={child} data-meeting-date={isoDate}>
                  <div class="cell-status" id={`status-${isoDate}-${child}`}>‚ùì</div>
                  <div class="cell-buttons">
                    <button 
                      class="cell-btn cell-yes" 
                      data-child={child} 
                      data-meeting-date={isoDate}
                      data-status="üëç"
                      aria-label={`Mark ${child} as attending ${meeting.data.title}`}
                    >
                      üëç
                    </button>
                    <button 
                      class="cell-btn cell-no" 
                      data-child={child} 
                      data-meeting-date={isoDate}
                      data-status="üëé"
                      aria-label={`Mark ${child} as not attending ${meeting.data.title}`}
                    >
                      üëé
                    </button>
                  </div>
                </div>
              ))}
            </div>
          );
        })}
      </div>
    </div>
  </div>
</Layout>

<style>
  .rsvp-page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: calc(var(--grid-unit) * 3);
  }

  .rsvp-header {
    text-align: center;
    margin-bottom: calc(var(--grid-unit) * 4);
    position: relative;
  }

  .rsvp-header h1 {
    font-family: var(--font-heading-primary);
    font-size: 3rem;
    font-weight: 900;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    line-height: 1.1;
    margin: 0 0 calc(var(--grid-unit) * 2) 0;
  }

  .rsvp-header p {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .rsvp-updating-global {
    position: absolute;
    top: calc(var(--grid-unit) * 2);
    right: 0;
    display: flex;
    align-items: center;
    gap: calc(var(--grid-unit) / 2);
    padding: calc(var(--grid-unit)) calc(var(--grid-unit) * 1.5);
    background: rgba(34, 197, 94, 0.95);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 20px;
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    backdrop-filter: blur(10px);
    z-index: 10;
    animation: slideInRight 0.3s ease-out;
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  .rsvp-loading-global {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: calc(var(--grid-unit));
    padding: calc(var(--grid-unit) * 4);
    color: var(--color-text-muted);
    font-style: italic;
  }

  .loading-spinner-global,
  .updating-spinner-global {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-border);
    border-top: 2px solid var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .updating-spinner-global {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .rsvp-error-global {
    text-align: center;
    padding: calc(var(--grid-unit) * 3);
    color: var(--color-accent);
  }

  .retry-button {
    background: var(--color-accent);
    color: white;
    border: none;
    padding: calc(var(--grid-unit)) calc(var(--grid-unit) * 2);
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-heading-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: calc(var(--grid-unit));
    transition: all 0.2s ease;
  }

  .retry-button:hover {
    background: var(--color-text-primary);
    transform: translateY(-1px);
  }

  .rsvp-grid-container {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: calc(var(--grid-unit) * 3);
    overflow-x: auto;
  }

  .rsvp-grid {
    display: grid;
    grid-template-columns: 250px repeat(6, 120px);
    gap: 1px;
    background: var(--color-border);
    border-radius: 8px;
    overflow: hidden;
    min-width: 970px;
  }

  .grid-header {
    display: contents;
  }

  .meeting-header-cell,
  .child-header-cell {
    background: var(--color-accent);
    color: white;
    padding: calc(var(--grid-unit) * 2);
    font-family: var(--font-heading-secondary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: center;
    font-size: 0.9rem;
  }

  .meeting-header-cell {
    text-align: left;
  }

  .grid-row {
    display: contents;
  }

  .meeting-cell {
    background: var(--color-background);
    padding: calc(var(--grid-unit) * 2);
    display: flex;
    align-items: center;
  }

  .meeting-info {
    width: 100%;
  }

  .meeting-link {
    font-weight: 600;
    color: var(--color-text-primary);
    text-decoration: none;
    font-size: 0.95rem;
    line-height: 1.3;
    display: block;
    margin-bottom: calc(var(--grid-unit) / 2);
  }

  .meeting-link:hover {
    color: var(--color-accent);
  }

  .meeting-date {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .rsvp-cell {
    background: var(--color-background);
    padding: calc(var(--grid-unit) * 1.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: calc(var(--grid-unit));
    position: relative;
    transition: all 0.3s ease;
  }

  .rsvp-cell.status-attending {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.04) 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
  }

  .rsvp-cell.status-not-attending {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.04) 100%);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .cell-status {
    font-size: 1.1rem;
    text-align: center;
  }

  .cell-buttons {
    display: flex;
    gap: calc(var(--grid-unit) / 2);
  }

  .cell-btn {
    background: transparent;
    border: 2px solid var(--color-border);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cell-btn:hover {
    transform: scale(1.1);
    border-color: var(--color-accent);
  }

  .cell-btn:active {
    transform: scale(0.95);
  }

  .cell-btn.active {
    border-color: var(--color-accent);
    background: rgba(220, 38, 38, 0.1);
  }

  .cell-btn.active[data-status="üëç"] {
    border-color: #16a34a;
    background: rgba(34, 197, 94, 0.15);
  }

  .cell-btn.active[data-status="üëé"] {
    border-color: #dc2626;
    background: rgba(239, 68, 68, 0.15);
  }

  .cell-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  @media (max-width: 1024px) {
    .rsvp-page-container {
      padding: calc(var(--grid-unit) * 2);
    }

    .rsvp-header h1 {
      font-size: 2.5rem;
    }

    .rsvp-grid {
      grid-template-columns: 200px repeat(6, 100px);
      min-width: 800px;
    }

    .meeting-header-cell,
    .child-header-cell {
      padding: calc(var(--grid-unit) * 1.5);
      font-size: 0.8rem;
    }

    .meeting-cell {
      padding: calc(var(--grid-unit) * 1.5);
    }

    .meeting-link {
      font-size: 0.85rem;
    }

    .meeting-date {
      font-size: 0.75rem;
    }

    .rsvp-cell {
      padding: calc(var(--grid-unit));
    }

    .cell-btn {
      width: 28px;
      height: 28px;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 768px) {
    .rsvp-header h1 {
      font-size: 2rem;
    }

    .rsvp-grid {
      grid-template-columns: 150px repeat(6, 80px);
      min-width: 630px;
    }

    .meeting-header-cell,
    .child-header-cell {
      padding: calc(var(--grid-unit));
      font-size: 0.7rem;
    }

    .meeting-cell {
      padding: calc(var(--grid-unit));
    }

    .meeting-link {
      font-size: 0.8rem;
    }

    .meeting-date {
      font-size: 0.7rem;
    }

    .rsvp-cell {
      padding: calc(var(--grid-unit) * 0.75);
      gap: calc(var(--grid-unit) / 2);
    }

    .cell-btn {
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
    }

    .cell-status {
      font-size: 1rem;
    }

    .rsvp-updating-global {
      position: static;
      margin-top: calc(var(--grid-unit) * 2);
      align-self: center;
    }
  }
</style>

<script define:vars={{ RSVP_API_URL, children }}>
  // Global RSVP Grid JavaScript
  class RSVPGrid {
    constructor() {
      this.apiUrl = RSVP_API_URL;
      this.children = children;
      this.currentData = null;
      
      this.init();
    }

    async init() {
      this.bindEvents();
      await this.loadAllRSVPData();
    }

    bindEvents() {
      // Retry button
      const retryBtn = document.getElementById('rsvp-retry-global');
      if (retryBtn) {
        retryBtn.addEventListener('click', () => this.loadAllRSVPData());
      }

      // RSVP cell buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('cell-btn')) {
          const child = e.target.dataset.child;
          const meetingDate = e.target.dataset.meetingDate;
          const status = e.target.dataset.status;
          this.updateRSVP(meetingDate, child, status);
        }
      });
    }

    async loadAllRSVPData() {
      this.showLoading();
      
      try {
        console.log('Loading all RSVP data');
        const response = await fetch(this.apiUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('API response:', data);
        this.currentData = data;
        
        this.renderAllRSVPData(data);
        this.showContent();
        
      } catch (error) {
        console.error('Failed to load RSVP data:', error);
        this.showError('Unable to load RSVP data');
      }
    }

    async updateRSVP(meetingDate, childName, status) {
      // Update UI immediately (optimistically) and disable buttons
      this.updateCellOptimistically(meetingDate, childName, status);
      this.setCellButtonsDisabled(meetingDate, childName, true);
      this.showUpdating();
      
      try {
        console.log('Updating RSVP:', { meetingDate, kidName: childName, status });
        
        // Try the real API call
        const updateUrl = new URL(this.apiUrl);
        updateUrl.searchParams.set('action', 'update');
        updateUrl.searchParams.set('meetingDate', meetingDate);
        updateUrl.searchParams.set('kidName', childName);
        updateUrl.searchParams.set('status', status);

        const response = await fetch(updateUrl.toString());
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Real API call succeeded - no need to reload, UI is already updated
            this.hideUpdating();
            return;
          }
        }
        
        // If API call failed, UI is already updated optimistically
        console.warn('API call failed, keeping optimistic update');
        this.hideUpdating();
        
      } catch (error) {
        console.error('Failed to update RSVP:', error);
        // UI is already updated optimistically
        this.hideUpdating();
      } finally {
        this.setCellButtonsDisabled(meetingDate, childName, false);
      }
    }

    updateCellOptimistically(meetingDate, childName, status) {
      // Update the status display
      const statusElement = document.getElementById(`status-${meetingDate}-${childName}`);
      if (statusElement) {
        statusElement.textContent = status;
      }

      // Update button states
      const buttons = document.querySelectorAll(`[data-child="${childName}"][data-meeting-date="${meetingDate}"]`);
      buttons.forEach(btn => {
        if (btn.classList.contains('cell-btn')) {
          btn.classList.remove('active');
          if (btn.dataset.status === status) {
            btn.classList.add('active');
          }
        }
      });
      
      // Update cell background based on status
      const rsvpCell = document.querySelector(`[data-child="${childName}"][data-meeting-date="${meetingDate}"].rsvp-cell`);
      if (rsvpCell) {
        // Remove existing status classes
        rsvpCell.classList.remove('status-attending', 'status-not-attending');
        
        // Add appropriate status class
        if (status === 'üëç') {
          rsvpCell.classList.add('status-attending');
        } else if (status === 'üëé') {
          rsvpCell.classList.add('status-not-attending');
        }
      }
    }

    renderAllRSVPData(allData) {
      // Create a lookup map for quick access
      const dataMap = new Map();
      allData.forEach(meetingData => {
        const meetingDate = meetingData.meetingDate;
        // Convert API date to YYYY-MM-DD format for comparison
        const apiDateOnly = meetingDate.includes('T') ? meetingDate.split('T')[0] : meetingDate;
        
        const kidsMap = new Map();
        meetingData.kids.forEach(kid => {
          kidsMap.set(kid.name, kid.status || '‚ùì');
        });
        dataMap.set(apiDateOnly, kidsMap);
      });

      // Update all cells
      const gridRows = document.querySelectorAll('.grid-row');
      gridRows.forEach(row => {
        const meetingDate = row.dataset.meetingDate;
        const meetingData = dataMap.get(meetingDate);
        
        this.children.forEach(child => {
          const statusElement = document.getElementById(`status-${meetingDate}-${child}`);
          const rsvpCell = document.querySelector(`[data-child="${child}"][data-meeting-date="${meetingDate}"].rsvp-cell`);
          
          let status = '‚ùì';
          if (meetingData && meetingData.has(child)) {
            status = meetingData.get(child);
          }
          
          if (statusElement) {
            statusElement.textContent = status;
          }

          // Update button states
          const buttons = document.querySelectorAll(`[data-child="${child}"][data-meeting-date="${meetingDate}"].cell-btn`);
          buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.status === status) {
              btn.classList.add('active');
            }
          });
          
          // Update cell background based on status
          if (rsvpCell) {
            rsvpCell.classList.remove('status-attending', 'status-not-attending');
            
            if (status === 'üëç') {
              rsvpCell.classList.add('status-attending');
            } else if (status === 'üëé') {
              rsvpCell.classList.add('status-not-attending');
            }
          }
        });
      });
    }

    setCellButtonsDisabled(meetingDate, childName, disabled) {
      const buttons = document.querySelectorAll(`[data-child="${childName}"][data-meeting-date="${meetingDate}"].cell-btn`);
      buttons.forEach(btn => {
        btn.disabled = disabled;
      });
    }

    showLoading() {
      document.getElementById('rsvp-loading-global').style.display = 'flex';
      document.getElementById('rsvp-error-global').style.display = 'none';
      document.getElementById('rsvp-grid-container').style.display = 'none';
    }

    showError(message) {
      document.getElementById('rsvp-error-message-global').textContent = message;
      document.getElementById('rsvp-loading-global').style.display = 'none';
      document.getElementById('rsvp-error-global').style.display = 'block';
      document.getElementById('rsvp-grid-container').style.display = 'none';
    }

    showContent() {
      document.getElementById('rsvp-loading-global').style.display = 'none';
      document.getElementById('rsvp-error-global').style.display = 'none';
      document.getElementById('rsvp-grid-container').style.display = 'block';
    }

    showUpdating() {
      document.getElementById('rsvp-updating-global').style.display = 'flex';
    }

    hideUpdating() {
      document.getElementById('rsvp-updating-global').style.display = 'none';
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new RSVPGrid();
  });
</script>